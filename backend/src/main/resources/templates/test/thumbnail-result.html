<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì¸ë„¤ì¼ í™•ì¸ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; max-width: 800px; margin: 0 auto;}
    .container { border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-top: 20px;}
    .image-box { margin-top: 20px; min-height: 200px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border: 2px dashed #ccc;}
    img { max-width: 100%; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .badge { display: inline-block; padding: 5px 10px; border-radius: 15px; color: white; font-weight: bold;}
    .COMPLETED { background-color: #27ae60; }
    .PROCESSING { background-color: #f39c12; }
    .FAILED { background-color: #c0392b; }
    .btn { padding: 10px 20px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; border: none; cursor: pointer;}
    .btn:hover { background-color: #2980b9; }
  </style>
</head>
<body>

<h1>ğŸ–¼ï¸ ì¸ë„¤ì¼ API í…ŒìŠ¤íŠ¸</h1>

<div class="container">
  <h3>ìš”ì²­ ì •ë³´</h3>
  <p>Request ID: <strong th:text="${requestId}"></strong></p>
  <p>Status: <span class="badge" th:classappend="${status}" th:text="${status}"></span></p>

  <div th:if="${resultId != null}">
    <p>Result ID: <strong th:text="${resultId}" style="color: #d35400;"></strong></p>

    <hr>

    <h3>1. GET ë°©ì‹ (Result ID ê¸°ë°˜)</h3>
    <p>API ê²½ë¡œ: <code>/api/v1/record/{resultId}/thumbnail</code></p>
    <p>HTML <code>&lt;img&gt;</code> íƒœê·¸ì— srcë¡œ ì§ì ‘ ì—°ê²°í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.</p>

    <div class="image-box">
      <img th:src="@{/api/v1/record/{resultId}/thumbnail(resultId=${resultId})}" alt="Detection Thumbnail">
    </div>
  </div>

  <div th:unless="${resultId != null}">
    <p style="color: #7f8c8d;">
      ë¶„ì„ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ Result IDê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
      ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.
    </p>
    <button onclick="location.reload()" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </div>
</div>

<div class="container" style="margin-top: 30px; border-color: #eee;">
  <h3>2. POST ë°©ì‹ (Polling, Request ID ê¸°ë°˜)</h3>
  <p>API ê²½ë¡œ: <code>/api/v1/detection/thumbnail/polling</code></p>
  <p>ìë°”ìŠ¤í¬ë¦½íŠ¸ fetchë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë°›ì•„ì˜µë‹ˆë‹¤.</p>

  <button id="pollBtn" class="btn" style="background-color: #9b59b6;">í´ë§ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°</button>

  <div class="image-box" id="pollingImageBox">
    <span style="color:#aaa;">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ì´ë¯¸ì§€ê°€ ë¡œë“œë©ë‹ˆë‹¤.</span>
  </div>
</div>

<div style="margin-top: 30px;">
  <a th:href="@{/api/test/detection/result/{id}(id=${requestId})}" style="color: #666;">ğŸ”™ ê²°ê³¼ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script th:inline="javascript">
  /* Thymeleaf ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸° */
  const requestId = [[${requestId}]];

  document.getElementById('pollBtn').addEventListener('click', function() {
    const container = document.getElementById('pollingImageBox');
    container.innerHTML = 'ë¡œë”© ì¤‘...';

    // 1. Form Data ìƒì„±
    const formData = new FormData();
    formData.append('requestId', requestId);

    // 2. Fetch ìš”ì²­ (POST)
    fetch('/api/v1/detection/thumbnail/polling', {
      method: 'POST',
      body: formData
    })
            .then(response => {
              if (response.status === 200) {
                return response.blob(); // ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
              } else if (response.status === 202) {
                throw new Error("ì•„ì§ ì¸ë„¤ì¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤ (202 Accepted)");
              } else {
                throw new Error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ (Status: " + response.status + ")");
              }
            })
            .then(blob => {
              // 3. Blob URL ìƒì„± ë° ì´ë¯¸ì§€ í‘œì‹œ
              const imageUrl = URL.createObjectURL(blob);
              container.innerHTML = `<img src="${imageUrl}" alt="Polling Thumbnail" />`;
            })
            .catch(err => {
              container.innerHTML = `<span style="color: red;">${err.message}</span>`;
            });
  });
</script>

</body>
</html>