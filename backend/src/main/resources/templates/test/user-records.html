<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ì˜ ë¶„ì„ ê¸°ë¡ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 40px; background-color: #f4f6f8; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    /* ìƒë‹¨ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ */
    .auth-section { background-color: #eaf2f8; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #bdc3c7; }
    .auth-section h3 { margin-top: 0; color: #2980b9; }
    .input-group { display: flex; gap: 10px; align-items: center; }
    input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px; }

    h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f8f9fa; font-weight: 600; color: #555; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }

    .score-real { color: #27ae60; font-weight: bold; }
    .score-fake { color: #c0392b; font-weight: bold; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; color: white; background-color: #95a5a6; }

    .btn { padding: 8px 15px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    .btn:hover { background-color: #2980b9; }
    .btn-load { display: block; width: 100%; margin-top: 20px; padding: 15px; font-size: 16px; background-color: #95a5a6; }
    .btn-load.active { background-color: #3498db; }
  </style>
</head>
<body>

<div class="container">

  <div class="auth-section">
    <h3>ğŸ› ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •</h3>
    <p>í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ì€ <strong>Member ID</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (í•´ë‹¹ IDë¡œ ì„¸ì…˜ì´ ìƒì„±ë©ë‹ˆë‹¤)</p>
    <div class="input-group">
      <input type="number" id="testMemberId" placeholder="Member ID (ex: 1)" value="1">
      <button class="btn" onclick="setTestSession()">1. ì‚¬ìš©ì ë¡œê·¸ì¸(ì„¸ì…˜ ì„¤ì •)</button>
    </div>
    <p id="authStatus" style="color: green; font-weight: bold; margin-top: 10px;"></p>
  </div>

  <h1>
    <span>ğŸ“œ ë¶„ì„ ê¸°ë¡ ì¡°íšŒ</span>
    <button class="btn" onclick="resetAndLoad()" style="font-size: 0.6em; float: right;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  </h1>

  <table>
    <thead>
    <tr>
      <th>Result ID</th>
      <th>ìƒì„±ì¼ì‹œ</th>
      <th>ë¶„ì„ ì‹œê°„</th>
      <th>Real / Fake</th>
      <th>ìƒì„¸</th>
    </tr>
    </thead>
    <tbody id="recordList">
    </tbody>
  </table>

  <div id="emptyMsg" style="text-align: center; padding: 30px; color: #999; display: none;">
    í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ë¡œê·¸ì¸ì´ ë˜ì–´ìˆì§€ ì•Šê±°ë‚˜ ê¸°ë¡ì´ ì—†ìŒ)
  </div>

  <button id="loadMoreBtn" class="btn btn-load" onclick="loadRecords()" style="display: none;">
    â¬‡ï¸ ë” ë³´ê¸° (Load More)
  </button>
</div>

<script>
  let nextCursor = null; // ë‹¤ìŒ í˜ì´ì§€ ì»¤ì„œ
  let hasNext = false;
  let isLoading = false;
  const limit = 5;       // í•œ í˜ì´ì§€ë‹¹ ê°œìˆ˜ (í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì‘ê²Œ ì„¤ì •)

  // 1. ì„¸ì…˜ ì„¤ì • (Mock Login)
  function setTestSession() {
    const memberId = document.getElementById('testMemberId').value;
    if (!memberId) { alert("Member IDë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

    fetch(`/api/test/detection/auth/mock?memberId=${memberId}`, { method: 'POST' })
            .then(res => {
              if (res.ok) return res.text();
              throw new Error("ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨");
            })
            .then(msg => {
              document.getElementById('authStatus').textContent = "âœ… " + msg;
              // ì„¸ì…˜ ì„¤ì • ì„±ê³µ í›„ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ë¡œë“œ
              resetAndLoad();
            })
            .catch(err => {
              alert(err.message);
              document.getElementById('authStatus').textContent = "âŒ ì„¤ì • ì‹¤íŒ¨";
            });
  }

  // ì´ˆê¸°í™” í›„ ë¡œë“œ
  function resetAndLoad() {
    document.getElementById('recordList').innerHTML = '';
    nextCursor = null;
    hasNext = false;
    loadRecords();
  }

  // 2. ì‹¤ì œ ë°ì´í„° ì¡°íšŒ (GET /api/v1/record)
  function loadRecords() {
    if (isLoading) return;
    isLoading = true;

    // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° êµ¬ì„±
    let url = `/api/v1/record?limit=${limit}`;
    if (nextCursor) {
      url += `&cursor=${nextCursor}`;
    }

    fetch(url)
            .then(response => {
              if (response.status === 401) {
                throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ì—ì„œ 'ì‚¬ìš©ì ë¡œê·¸ì¸'ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.");
              }
              if (!response.ok) throw new Error("ë°ì´í„° ì¡°íšŒ ì—ëŸ¬ (" + response.status + ")");
              return response.json();
            })
            .then(data => {
              // data = DetectionListResponse { items: [], pageInfo: { ... } }
              renderItems(data.items);
              updatePagination(data.pageInfo);
            })
            .catch(err => {
              console.error(err);
              if(document.getElementById('recordList').children.length === 0) {
                document.getElementById('emptyMsg').textContent = "âš ï¸ " + err.message;
                document.getElementById('emptyMsg').style.display = 'block';
              } else {
                alert(err.message);
              }
            })
            .finally(() => {
              isLoading = false;
            });
  }

  // í…Œì´ë¸” ë Œë”ë§
  function renderItems(items) {
    const tbody = document.getElementById('recordList');
    const emptyMsg = document.getElementById('emptyMsg');

    if (!items || items.length === 0) {
      if (tbody.children.length === 0) emptyMsg.style.display = 'block';
      return;
    }
    emptyMsg.style.display = 'none';

    items.forEach(item => {
      const tr = document.createElement('tr');
      tr.onclick = () => location.href = `/api/test/detection/result/detail/${item.resultId}`; // ìƒì„¸ í˜ì´ì§€ ì´ë™

      const date = new Date(item.createdAt).toLocaleString();
      const real = (item.probabilityReal * 100).toFixed(1);
      const fake = (item.probabilityFake * 100).toFixed(1);

      tr.innerHTML = `
                <td>#${item.resultId}</td>
                <td style="color:#666; font-size:0.9em;">${date}</td>
                <td>${item.durationSec}s</td>
                <td>
                    <span class="score-real">Real ${real}%</span> /
                    <span class="score-fake">Fake ${fake}%</span>
                </td>
                <td><span class="badge">View</span></td>
            `;
      tbody.appendChild(tr);
    });
  }

  // ë” ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  function updatePagination(pageInfo) {
    const btn = document.getElementById('loadMoreBtn');

    if (pageInfo && pageInfo.hasNextPage) {
      nextCursor = pageInfo.nextCursor;
      hasNext = true;
      btn.style.display = 'block';
      btn.classList.add('active');
      btn.textContent = 'â¬‡ï¸ ë” ë³´ê¸° (Load More)';
    } else {
      nextCursor = null;
      hasNext = false;
      btn.style.display = 'none';
    }
  }
</script>

</body>
</html>