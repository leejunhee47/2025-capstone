<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê²°ê³¼ ë³´ê³ ì„œ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background-color: #f9f9f9; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 15px; }

    .status-box { padding: 15px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; }
    .status-COMPLETED { background-color: #d4edda; color: #155724; }
    .status-PENDING { background-color: #fff3cd; color: #856404; }
    .status-FAILED { background-color: #f8d7da; color: #721c24; }

    .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .image-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .image-card img { width: 100%; height: auto; display: block; }
    .image-info { padding: 10px; background: #f8f9fa; font-size: 14px; text-align: center; border-top: 1px solid #ddd; }

    .json-preview { background: #2d3436; color: #fab1a0; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; margin-top: 20px; display: none; }
    .btn { display: inline-block; padding: 10px 20px; text-decoration: none; color: white; background-color: #3498db; border-radius: 5px; margin-top: 20px; cursor: pointer; border: none; }
    .btn:hover { background-color: #2980b9; }
    .btn-toggle { background-color: #636e72; font-size: 0.9em; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“‘ ê²°ê³¼ ë³´ê³ ì„œ (ì´ë¯¸ì§€) í…ŒìŠ¤íŠ¸</h1>

  <div th:class="'status-box status-' + ${status}">
    Current Status: <span th:text="${status}">UNKNOWN</span>
  </div>

  <div th:if="${errorMessage}" style="color: red; margin-bottom: 20px;">
    <p>âš ï¸ <span th:text="${errorMessage}">Error</span></p>
  </div>

  <div th:if="${message}" style="margin-bottom: 20px;">
    <p th:text="${message}"></p>
  </div>

  <div th:if="${resultId != null}" id="reportArea">
    <p>Result ID: <strong th:text="${resultId}"></strong></p>
    <p>ì•„ë˜ ì´ë¯¸ì§€ëŠ” APIë¥¼ í†µí•´ JSONì„ ë°›ì•„ì˜¨ í›„ ë Œë”ë§ëœ ê²ƒì…ë‹ˆë‹¤.</p>

    <div class="image-gallery" id="imageGallery">
      <p style="color: gray;">ì´ë¯¸ì§€ ë¡œë”© ì¤‘...</p>
    </div>

    <button class="btn btn-toggle" onclick="toggleJson()">ğŸ” JSON ì›ë³¸ ë³´ê¸°</button>
    <pre id="jsonPreview" class="json-preview"></pre>
  </div>

  <hr>
  <a th:href="@{/api/test/detection/result/{id}(id=${requestId})}" class="btn" style="background-color: #95a5a6;">ğŸ”™ ë’¤ë¡œ ê°€ê¸°</a>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const resultId = [[${resultId}]];
  /*]]>*/

  if (resultId) {
    loadReportImages(resultId);
  }

  function loadReportImages(id) {
    // 1. ê²°ê³¼ ë³´ê³ ì„œ URL ì¡°íšŒ API í˜¸ì¶œ
    fetch(`/api/v1/record/${id}/report`)
            .then(response => {
              if (!response.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨: " + response.status);
              return response.json();
            })
            .then(data => {
              // JSON ë¯¸ë¦¬ë³´ê¸°ìš©
              document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);

              renderGallery(data.images);
            })
            .catch(error => {
              console.error(error);
              document.getElementById('imageGallery').innerHTML = `<p style="color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>${error.message}</p>`;
            });
  }

  function renderGallery(images) {
    const gallery = document.getElementById('imageGallery');
    gallery.innerHTML = ''; // ì´ˆê¸°í™”

    if (!images || images.length === 0) {
      gallery.innerHTML = '<p>í‘œì‹œí•  ê²°ê³¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    images.forEach(imgInfo => {
      // imgInfo êµ¬ì¡°: { sequence: 1, url: "..." }

      const card = document.createElement('div');
      card.className = 'image-card';

      // ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
      // 2. ì‹¤ì œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” API ê²½ë¡œê°€ imgInfo.urlì— ë“¤ì–´ìˆë‹¤ê³  ê°€ì •
      // ë§Œì•½ urlì´ ì „ì²´ ê²½ë¡œê°€ ì•„ë‹ˆë¼ IDë§Œ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì¡°í•©í•´ì•¼ í•¨.
      // (Service ë¡œì§ìƒ url í•„ë“œì— API í’€ ê²½ë¡œ í˜¹ì€ ìƒëŒ€ ê²½ë¡œê°€ ìˆë‹¤ê³  ê°€ì •)
      const img = document.createElement('img');
      img.src = imgInfo.url;
      img.alt = `Result Image ${imgInfo.sequence}`;

      // ì´ë¯¸ì§€ ë¡œë“œ ì—ëŸ¬ ì²˜ë¦¬
      img.onerror = function() {
        this.src = 'https://via.placeholder.com/300x200?text=Image+Load+Error';
      };

      const info = document.createElement('div');
      info.className = 'image-info';
      info.textContent = `#${imgInfo.sequence} (Click to View Original)`;

      // í´ë¦­ ì‹œ ìƒˆ íƒ­ì—ì„œ ì›ë³¸ ë³´ê¸°
      const link = document.createElement('a');
      link.href = imgInfo.url;
      link.target = '_blank';
      link.appendChild(img);

      card.appendChild(link);
      card.appendChild(info);
      gallery.appendChild(card);
    });
  }

  function toggleJson() {
    const pre = document.getElementById('jsonPreview');
    pre.style.display = (pre.style.display === 'none' || pre.style.display === '') ? 'block' : 'none';
  }
</script>

</body>
</html>